<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KL Property Auction Live - Student</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#0f172a 0%,#1e3a8a 50%,#0f172a 100%); color:white; min-height:100vh;}
        .container{max-width:1400px;margin:0 auto;padding:20px;}
        .header{padding:30px 0;margin-bottom:40px;border-bottom:2px solid rgba(34,211,238,0.2);}
        .header h1{font-size:2.2rem;background:linear-gradient(90deg,#a5f3fc 0%,#60a5fa 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px;}
        .input-group{display:flex;gap:10px;max-width:400px;}
        input{flex:1;padding:12px;border-radius:8px;background:rgba(30,58,138,0.5);border:1px solid rgba(34,211,238,0.3);color:white}
        button{padding:10px 16px;border-radius:8px;border:none;background:linear-gradient(90deg,#06b6d4 0%,#3b82f6 100%);color:white;cursor:pointer;}
        .main-content{display:grid;grid-template-columns:1fr 350px;gap:20px}
        .auction-card{background:linear-gradient(135deg,rgba(30,58,138,0.35),rgba(30,99,145,0.35));border-radius:16px;padding:28px;border:1px solid rgba(34,211,238,0.2)}
        .property-image{font-size:4rem;text-align:center;padding:24px 0}
        .price-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:20px 0}
        .price-box{background:rgba(15,23,42,0.6);padding:16px;border-radius:10px}
        .price-box.active{border:1px solid rgba(6,182,212,0.5)}
        .bid-buttons{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
        .bid-btn{padding:12px;border-radius:8px;background:linear-gradient(135deg,#06b6d4 0%,#0891b2 100%);color:white;border:none;font-weight:600}
        .bidders-list{background:linear-gradient(135deg,rgba(30,58,138,0.35),rgba(30,99,145,0.35));padding:16px;border-radius:12px;max-height:640px;overflow:auto}
        .sold-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.95);display:none;justify-content:center;align-items:center;z-index:1000;flex-direction:column;gap:18px}
        .sold-overlay.active{display:flex}

        /* âœ… GIF å®¹å™¨ï¼ˆä»…æ›¿ä»£ SVGï¼‰ */
        .gavel-container img{
            width:260px;
            display:block;
            margin-bottom:10px;
        }

        .sold-message{font-size:2.8rem;font-weight:700;background:linear-gradient(90deg,#fbbf24 0%,#f97316 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
        .sold-details{color:#a5f3fc;font-size:1.2rem}
        .hidden{display:none}
    </style>
</head>

<body>

<div class="sold-overlay" id="soldOverlay">

    <!-- âŒ åŸ SVG å·²ç§»é™¤ -->
    <!-- âœ… æ”¹æˆ GIF å®¹å™¨ï¼ˆä¸å½±å“å…¶ä»–ç»“æ„ï¼‰ -->
    <div class="gavel-container" id="gavelContainer"></div>

    <div class="sold-message">SOLD! ğŸ‰</div>
    <div class="sold-details" id="soldDetails">èµ¢å®¶: â€”</div>
    <div class="sold-details">â³ ç­‰å¾…è€å¸ˆè¿›å…¥ä¸‹ä¸€ä»¶æˆ¿äº§...</div>
</div>

<div class="container">
    <div class="header">
        <h1>ğŸ”¨ KL Property Auction Live</h1>
        <div id="userInputSection">
            <div class="input-group">
                <input type="text" id="userNameInput" placeholder="è¾“å…¥ä½ çš„åå­—..." />
                <button onclick="joinAuction()">åŠ å…¥ç«æ‹</button>
            </div>
        </div>
        <div id="welcomeText" class="hidden">æ¬¢è¿, <span id="displayName"></span></div>
    </div>

    <div id="mainContent" class="hidden">
        <div class="main-content">
            <div class="auction-card">
                <div class="property-image" id="propertyImage">ğŸ¢</div>
                <h2 id="propertyAddress">Pavilion KL</h2>
                <div class="price-grid">
                    <div class="price-box"><div>èµ·ä»·</div><div id="openingPrice">RM 500,000</div></div>
                    <div class="price-box active"><div>å½“å‰å‡ºä»·</div><div id="currentPrice">RM 500,000</div></div>
                </div>
                <div>æœ€é«˜ç«ä»·è€…ï¼š<strong id="highBidder">ç­‰å¾…ä¸­...</strong></div>
                <div class="bid-buttons">
                    <button class="bid-btn" onclick="placeBid(5000)">+RM 5,000</button>
                    <button class="bid-btn" onclick="placeBid(10000)">+RM 10,000</button>
                    <button class="bid-btn" onclick="placeBid(15000)">+RM 15,000</button>
                    <button class="bid-btn" onclick="placeBid(25000)">+RM 25,000</button>
                </div>
            </div>
            <div class="bidders-list"><div id="biddersList">ç­‰å¾…ç«ä»·è€…...</div></div>
        </div>
    </div>
</div>

<script>
const SUPABASE_URL = 'https://ubxfggqfnhvqyatgiolx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVieGZnZ3Fmbmh2cXlhdGdpb2x4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzM3NDEsImV4cCI6MjA4MzUwOTc0MX0.fxlPFVuHlwLG56bPOeP2s6qsoQn5aEgeBrdHfkvjvyM';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let userName = '';
let currentPropertyObj = null;
let soldAlreadyShown = false;

async function joinAuction(){
    userName = document.getElementById('userNameInput').value.trim();
    if(!userName) return alert('è¯·è¾“å…¥ä½ çš„åå­—');
    document.getElementById('userInputSection').classList.add('hidden');
    document.getElementById('welcomeText').classList.remove('hidden');
    document.getElementById('displayName').textContent = userName;
    document.getElementById('mainContent').classList.remove('hidden');

    sb.channel('properties-changes')
      .on('postgres_changes',{event:'*',schema:'public',table:'properties'},loadData)
      .subscribe();

    loadData();
}

async function loadData(){
    const { data } = await sb.from('properties').select('*').limit(1).single();
    if(!data) return;
    currentPropertyObj = data;
    updateUI();

    if(data.status === 'sold'){
        if(!soldAlreadyShown){
            showSoldOverlay();
            soldAlreadyShown = true;
        }
    }else{
        hideSoldOverlay();
        soldAlreadyShown = false;
    }
}

async function placeBid(inc){
    const bid = Number(currentPropertyObj.current_price||0) + inc;
    await sb.from('properties')
      .update({current_price:bid, highest_bidder:userName})
      .eq('id', currentPropertyObj.id);
}

/* âœ… å”¯ä¸€è¢«æ”¹çš„ JSï¼šGIF é‡æ–°æ’­æ”¾ */
function playGavelAnimation(){
    const container = document.getElementById('gavelContainer');
    container.innerHTML = '';
    const img = document.createElement('img');
    img.src = 'gavel.gif'; // å’Œ HTML åŒç›®å½•
    container.appendChild(img);
}

function showSoldOverlay(){
    document.getElementById('soldDetails').textContent =
        `èµ¢å®¶: ${currentPropertyObj.highest_bidder} - RM ${Number(currentPropertyObj.current_price).toLocaleString()}`;
    playGavelAnimation();
    document.getElementById('soldOverlay').classList.add('active');
}
function hideSoldOverlay(){
    document.getElementById('soldOverlay').classList.remove('active');
}
function updateUI(){
    document.getElementById('currentPrice').textContent = `RM ${Number(currentPropertyObj.current_price).toLocaleString()}`;
    document.getElementById('highBidder').textContent = currentPropertyObj.highest_bidder || 'ç­‰å¾…ä¸­...';
}
</script>

</body>
</html>
