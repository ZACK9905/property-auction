<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KL Property Auction Live - Student</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#0f172a 0%,#1e3a8a 50%,#0f172a 100%); color:white; min-height:100vh;}
        .container{max-width:1400px;margin:0 auto;padding:20px;}
        .header{padding:30px 0;margin-bottom:40px;border-bottom:2px solid rgba(34,211,238,0.2);animation:slideDown .6s;}
        @keyframes slideDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
        .header h1{font-size:2.2rem;background:linear-gradient(90deg,#a5f3fc 0%,#60a5fa 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px;}
        .input-group{display:flex;gap:10px;max-width:400px;}
        input{flex:1;padding:12px;border-radius:8px;background:rgba(30,58,138,0.5);border:1px solid rgba(34,211,238,0.3);color:white}
        input::placeholder{color:rgba(255,255,255,0.5)}
        button{padding:10px 16px;border-radius:8px;border:none;background:linear-gradient(90deg,#06b6d4 0%,#3b82f6 100%);color:white;cursor:pointer;transition:all .2s}
        button:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(6,182,212,0.3)}
        .main-content{display:grid;grid-template-columns:1fr 350px;gap:20px}
        .auction-card{background:linear-gradient(135deg,rgba(30,58,138,0.35),rgba(30,99,145,0.35));border-radius:16px;padding:28px;animation:fadeIn .5s;border:1px solid rgba(34,211,238,0.2)}
        @keyframes fadeIn{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}
        .property-image{font-size:4rem;text-align:center;padding:24px 0;animation:float 3s ease-in-out infinite}
        @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
        .property-address{font-size:1.5rem;color:#a5f3fc;margin-bottom:8px}
        .property-description{color:#93c5fd;margin-bottom:20px}
        .price-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:20px 0}
        .price-box{background:rgba(15,23,42,0.6);padding:16px;border-radius:10px;border:1px solid rgba(59,130,246,0.2)}
        .price-box.active{border-color:rgba(6,182,212,0.5)}
        .price-label{color:#93c5fd;font-size:0.85rem;margin-bottom:6px}
        .price-amount{color:#06b6d4;font-size:1.4rem;font-weight:700}
        .bidder-info{background:rgba(15,23,42,0.6);padding:16px;border-radius:10px;margin:16px 0;border:1px solid rgba(59,130,246,0.2)}
        .bidder-name{color:#fbbf24;font-size:1.2rem;font-weight:600}
        .calling-status{background:rgba(239,68,68,0.15);padding:16px;border-radius:10px;margin:16px 0;border:2px solid rgba(239,68,68,0.3)}
        .calling-text{font-size:1.1rem;font-weight:600;margin-bottom:8px}
        .calling-text.first{color:#fbbf24}
        .calling-text.second{color:#fb923c}
        .calling-text.third{color:#ef4444}
        .calling-timer{font-family:'Courier New',monospace;font-size:2.2rem;color:#a5f3fc;animation:pulse .8s infinite;text-align:center}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
        .bid-buttons{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
        .bid-btn{padding:12px;border-radius:8px;background:linear-gradient(135deg,#06b6d4 0%,#0891b2 100%);color:white;border:2px solid transparent;cursor:pointer;transition:all .2s;font-weight:600}
        .bid-btn:hover{transform:scale(1.03);box-shadow:0 6px 18px rgba(6,182,212,0.25);border-color:rgba(165,243,252,0.5)}
        .bid-btn:active{transform:scale(0.98)}
        .bidders-list{background:linear-gradient(135deg,rgba(30,58,138,0.35),rgba(30,99,145,0.35));padding:16px;border-radius:12px;max-height:640px;overflow:auto;border:1px solid rgba(34,211,238,0.2)}
        .bidder-item{display:flex;justify-content:space-between;padding:10px;border-radius:8px;margin-bottom:8px;background:rgba(15,23,42,0.6);border:1px solid rgba(59,130,246,0.15);transition:all .2s}
        .bidder-item:hover{border-color:rgba(6,182,212,0.4);transform:translateX(2px)}
        .sold-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.95);display:none;justify-content:center;align-items:center;z-index:1000;flex-direction:column;gap:18px;backdrop-filter:blur(10px)}
        .sold-overlay.active{display:flex;animation:overlayFade .4s}
        @keyframes overlayFade{from{opacity:0}to{opacity:1}}
        .auction-hammer-container {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }
        /* é”¤å¤´æ•²å‡»æœ¨åº§çš„ä¸»è¦åŠ¨ç”» */
        #gavelHead {
            transform-origin: 0px 80px;
            animation: gavelStrike 0.8s cubic-bezier(.4,.1,.6,1) forwards;
        }
        @keyframes gavelStrike {
            0%   { transform: translate(100px, 60px) rotate(-35deg); }
            30%  { transform: translate(100px, 60px) rotate(-10deg); }
            50%  { transform: translate(100px, 90px) rotate(5deg); }
            60%  { transform: translate(100px, 85px) rotate(-3deg); }
            75%  { transform: translate(100px, 90px) rotate(3deg); }
            100% { transform: translate(100px, 90px) rotate(0deg); }
        }
        .sold-message{font-size:2.8rem;font-weight:700;background:linear-gradient(90deg,#fbbf24 0%,#f97316 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:celebration 1s ease-in-out}
        @keyframes celebration{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        .sold-details{color:#a5f3fc;font-size:1.2rem}
        .message-box{padding:12px;background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);border-radius:8px;color:#86efac;margin-top:12px;animation:slideIn .3s}
        @keyframes slideIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        .hidden{display:none}
        .property-info{color:#fbbf24;font-weight:600;margin-bottom:16px;font-size:1.1rem}
    </style>
</head>
<body>
    <div class="sold-overlay" id="soldOverlay">
        <div class="auction-hammer-container">
            <svg id="gavelSvg" width="220" height="220" viewBox="0 0 200 200">
                <!-- æœ¨åº§ -->
                <rect x="30" y="150" width="140" height="15" rx="6" fill="#8B5A2B"/>
                <rect x="40" y="165" width="120" height="8" rx="4" fill="#6B3E1A"/>

                <!-- æ‰‹æŸ„ -->
                <rect x="90" y="60" width="14" height="80" rx="7" fill="#8B5A2B"/>

                <!-- é”¤å¤´ç»„ -->
                <g id="gavelHead" transform="translate(100,60)">
                    <rect x="-60" y="-15" width="120" height="30" rx="8" fill="#A16207"/>
                    <rect x="-55" y="15" width="110" height="10" rx="5" fill="#78350F"/>
                </g>
            </svg>
        </div>
        <div class="sold-message">SOLD! ğŸ‰</div>
        <div class="sold-details" id="soldDetails">èµ¢å®¶: â€”</div>
        <div class="sold-details">â³ ç­‰å¾…è€å¸ˆè¿›å…¥ä¸‹ä¸€ä»¶æˆ¿äº§...</div>
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ”¨ KL Property Auction Live</h1>
            <div id="userInputSection">
                <div class="input-group">
                    <input type="text" id="userNameInput" placeholder="è¾“å…¥ä½ çš„åå­—..." />
                    <button onclick="joinAuction()">åŠ å…¥ç«æ‹</button>
                </div>
            </div>
            <div id="welcomeText" class="hidden">æ¬¢è¿, <span id="displayName"></span> ğŸ‘‹ | å‚ä¸äººæ•°: <span id="participantCount">0</span>/20</div>
        </div>

        <div id="mainContent" class="hidden">
            <div class="property-info" id="propertyInfo">æ­£åœ¨ç«æ‹æˆ¿äº§ 1/4</div>
            <div class="main-content">
                <div class="auction-card">
                    <div class="property-image" id="propertyImage">ğŸ¢</div>
                    <h2 class="property-address" id="propertyAddress">Pavilion KL</h2>
                    <p class="property-description" id="propertyDescription">è±ªåå…¬å¯“</p>

                    <div class="price-grid">
                        <div class="price-box">
                            <div class="price-label">èµ·ä»·</div>
                            <div class="price-amount" id="openingPrice">RM 500,000</div>
                        </div>
                        <div class="price-box active">
                            <div class="price-label">å½“å‰å‡ºä»·</div>
                            <div class="price-amount" id="currentPrice">RM 500,000</div>
                        </div>
                    </div>

                    <div class="bidder-info">
                        <div class="price-label">æœ€é«˜ç«ä»·è€…</div>
                        <div class="bidder-name" id="highBidder">ç­‰å¾…ä¸­...</div>
                    </div>

                    <div id="callingStatusDiv" class="calling-status hidden">
                        <div class="calling-text" id="callingText">1st Calling</div>
                        <div class="calling-timer" id="callingTimer">10</div>
                    </div>

                    <div style="font-size:0.9rem;color:#93c5fd;margin:10px 0">ä¸‹ä¸€ä¸ªå‡ºä»·è‡³å°‘: <strong id="minBidDisplay" style="color:#06b6d4">RM 505,000</strong></div>

                    <div class="bid-buttons">
                        <button class="bid-btn" onclick="placeBid(5000)">+RM 5,000</button>
                        <button class="bid-btn" onclick="placeBid(10000)">+RM 10,000</button>
                        <button class="bid-btn" onclick="placeBid(15000)">+RM 15,000</button>
                        <button class="bid-btn" onclick="placeBid(25000)">+RM 25,000</button>
                    </div>

                    <div id="messageBox" class="message-box hidden"></div>
                </div>

                <div class="bidders-list">
                    <div style="font-weight:700;margin-bottom:8px">ğŸ‘¥ ç«ä»·è€…æ’è¡Œ</div>
                    <div id="biddersList" style="text-align:center;color:#93c5fd;padding:8px">è¿æ¥ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ubxfggqfnhvqyatgiolx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVieGZnZ3Fmbmh2cXlhdGdpb2x4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzM3NDEsImV4cCI6MjA4MzUwOTc0MX0.fxlPFVuHlwLG56bPOeP2s6qsoQn5aEgeBrdHfkvjvyM';

        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const propertyInfo = {
            1: { address: 'Pavilion KL - è±ªåå…¬å¯“', image: 'ğŸ¢', openingBid: 500000, increment: 5000, description: 'å‰éš†å¡ä¸­å¿ƒé«˜ç«¯ä½å®…' },
            2: { address: 'Petaling Jaya - ç°ä»£ä½å®…', image: 'ğŸ¡', openingBid: 350000, increment: 5000, description: 'å®¶åº­å‹å–„çš„ç°ä»£ä½å®…' },
            3: { address: 'Bangsar - è±ªå®…', image: 'ğŸ°', openingBid: 650000, increment: 10000, description: 'é«˜ç«¯ç¤¾åŒºçš„ç‹¬ç«‹è±ªå®…' },
            4: { address: 'Subang Jaya - å…¬å¯“', image: 'ğŸ™ï¸', openingBid: 400000, increment: 5000, description: 'ç°ä»£åŒ–åŸå¸‚å…¬å¯“' },
        };

        let userName = '';
        let currentProperty = 1;
        let currentPropertyObj = null;
        let bidders = [];
        let soldAlreadyShown = false;
        let lastTeacherOpenNotified = null;

        async function joinAuction() {
            const input = document.getElementById('userNameInput');
            userName = input.value.trim();
            if (!userName) { 
                alert('è¯·è¾“å…¥ä½ çš„åå­—ï¼'); 
                return; 
            }

            document.getElementById('userInputSection').classList.add('hidden');
            document.getElementById('welcomeText').classList.remove('hidden');
            document.getElementById('displayName').textContent = userName;
            document.getElementById('mainContent').classList.remove('hidden');

            sb.channel('properties-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'properties' }, () => loadData())
                .subscribe();
            sb.channel('bidders-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'bidders' }, () => loadData())
                .subscribe();

            setInterval(updateTimers, 1000);
            await loadData();
        }

        async function loadData() {
            try {
                const { data: allProps, error: propsError } = await sb
                    .from('properties')
                    .select('*')
                    .order('id', { ascending: true });
                
                if (propsError) {
                    console.error('Properties error:', propsError);
                    showMessage('âŒ é€£æ¥å¤±æ•—ï¼š' + propsError.message);
                    return;
                }

                if (!allProps || allProps.length === 0) return;

                const teacherOpened = allProps
                    .filter(p => p.opened_by_teacher === true)
                    .sort((a, b) => b.id - a.id)[0];
                
                if (teacherOpened && teacherOpened.id !== currentProperty) {
                    currentProperty = teacherOpened.id;
                    currentPropertyObj = teacherOpened;
                    soldAlreadyShown = false;
                    if (lastTeacherOpenNotified !== teacherOpened.id) {
                        showMessage(`âœ¨ è€å¸ˆå·²æ‰“å¼€ä¸‹ä¸€ä»¶æˆ¿äº§ ${teacherOpened.id}ï¼Œé¡µé¢å·²åˆ‡æ¢`);
                        lastTeacherOpenNotified = teacherOpened.id;
                    }
                } else {
                    let found = allProps.find(p => p.id === currentProperty);
                    if (!found) { 
                        found = allProps[0]; 
                        currentProperty = found.id; 
                    }
                    currentPropertyObj = found;
                }

                // âœ… ä¿®å¾©ï¼šåªä½¿ç”¨ id æ’åºï¼ˆä¸ä¾è³´ created_atï¼‰
                const { data: biddersData, error: biddersError } = await sb
                    .from('bidders')
                    .select('*')
                    .eq('property_id', currentProperty)
                    .order('id', { ascending: false });
                
                if (biddersError) {
                    console.error('Bidders error:', biddersError);
                    showMessage('âŒ ç«¶åƒ¹è¨˜éŒ„è¼‰å…¥å¤±æ•—');
                    bidders = [];
                } else {
                    bidders = biddersData || [];
                }

                updateUI();

                if (currentPropertyObj && currentPropertyObj.status === 'sold') {
                    if (!soldAlreadyShown) { 
                        showSoldOverlay(); 
                        soldAlreadyShown = true; 
                    }
                } else {
                    hideSoldOverlay(); 
                    soldAlreadyShown = false;
                }
            } catch (err) {
                console.error('loadData error:', err);
                showMessage('âŒ ç³»çµ±éŒ¯èª¤ï¼š' + err.message);
            }
        }

        async function placeBid(increment) {
            if (!currentPropertyObj) {
                showMessage('âŒ æˆ¿ç”¢è³‡è¨Šæœªè¼‰å…¥');
                return;
            }
            
            if (currentPropertyObj.status === 'sold') {
                showMessage('âŒ æ­¤æˆ¿ç”¢å·²æˆäº¤');
                return;
            }

            try {
                const bidAmount = Number(currentPropertyObj.current_price || 0) + increment;
                
                const { error: updateError } = await sb
                    .from('properties')
                    .update({ 
                        current_price: bidAmount, 
                        highest_bidder: userName 
                    })
                    .eq('id', currentProperty);

                if (updateError) {
                    console.error('Update error:', updateError);
                    showMessage('âŒ å‡ºåƒ¹å¤±æ•—ï¼š' + updateError.message);
                    return;
                }

                // âœ… ä¿®å¾©ï¼šç§»é™¤ created_atï¼Œè®“ Supabase è‡ªå‹•è™•ç†
                const { error: insertError } = await sb
                    .from('bidders')
                    .insert({ 
                        property_id: currentProperty, 
                        bidder_name: userName, 
                        bid_amount: bidAmount
                    });

                if (insertError) {
                    console.error('Insert error:', insertError);
                    showMessage('âŒ è¨˜éŒ„å¤±æ•—ï¼š' + insertError.message);
                    return;
                }

                showMessage(`âœ“ ${userName} å‡ºä»· RM ${bidAmount.toLocaleString()}`);
                await loadData();
            } catch (err) {
                console.error('placeBid error:', err);
                showMessage('âŒ å‡ºä»·å¤±è´¥ï¼š' + err.message);
            }
        }

        function updateTimers() {
            if (!currentPropertyObj) return;
            if (currentPropertyObj.stage > 0 && currentPropertyObj.timer > 0) {
                currentPropertyObj.timer = Math.max(0, currentPropertyObj.timer - 1);
                const el = document.getElementById('callingTimer');
                if (el) el.textContent = String(currentPropertyObj.timer);
            }
        }

        function showMessage(text) {
            const box = document.getElementById('messageBox');
            box.innerHTML = text;
            box.classList.remove('hidden');
            setTimeout(()=>box.classList.add('hidden'), 3000);
        }

        function playGavelAnimation() {
            const head = document.getElementById('gavelHead');
            if (head) {
                head.style.animation = 'none';
                head.offsetHeight;
                head.style.animation = '';
            }
        }

        function showSoldOverlay() {
            if (!currentPropertyObj) return;
            document.getElementById('soldDetails').textContent = `èµ¢å®¶: ${currentPropertyObj.highest_bidder || 'æ— '} - RM ${Number(currentPropertyObj.current_price || 0).toLocaleString()}`;
            
            playGavelAnimation();
            
            const el = document.getElementById('soldOverlay');
            el.classList.remove('active');
            void el.offsetWidth;
            el.classList.add('active');
        }

        function hideSoldOverlay() { 
            document.getElementById('soldOverlay').classList.remove('active'); 
        }

        function updateUI() {
            updateDisplay();
            updateBidders();
            updateParticipants();
        }

        function updateDisplay() {
            if (!currentPropertyObj) return;
            const info = propertyInfo[currentProperty] || propertyInfo[1];
            const minBid = Number(currentPropertyObj.current_price || 0) + (info.increment || 5000);
            const imgEl = document.getElementById('propertyImage');

            imgEl.textContent = info.image;

            document.getElementById('propertyAddress').textContent = info.address;
            document.getElementById('propertyDescription').textContent = info.description;
            document.getElementById('openingPrice').textContent = `RM ${info.openingBid.toLocaleString()}`;
            document.getElementById('currentPrice').textContent = `RM ${Number(currentPropertyObj.current_price || 0).toLocaleString()}`;
            document.getElementById('highBidder').textContent = currentPropertyObj.highest_bidder || 'ç­‰å¾…ä¸­...';
            document.getElementById('minBidDisplay').textContent = `RM ${minBid.toLocaleString()}`;
            document.getElementById('propertyInfo').textContent = `æ­£åœ¨ç«æ‹æˆ¿äº§ ${currentProperty}/4`;

            const callingDiv = document.getElementById('callingStatusDiv');
            if (currentPropertyObj.stage > 0) {
                callingDiv.classList.remove('hidden');
                const stages = ['', '1st Calling', '2nd Calling', '3rd Calling - Going Once...'];
                const callingText = document.getElementById('callingText');
                callingText.textContent = stages[currentPropertyObj.stage] || 'Calling';
                callingText.className = currentPropertyObj.stage === 1 ? 'calling-text first' : 
                                       currentPropertyObj.stage === 2 ? 'calling-text second' : 
                                       'calling-text third';
                document.getElementById('callingTimer').textContent = currentPropertyObj.timer;
            } else {
                callingDiv.classList.add('hidden');
            }
        }

        function updateBidders() {
            if (!bidders || bidders.length === 0) {
                document.getElementById('biddersList').innerHTML = '<div style="color:#93c5fd">ç­‰å¾…ç«ä»·è€…...</div>';
                return;
            }
            const map = {};
            bidders.forEach(b => {
                if (!map[b.bidder_name] || b.bid_amount > map[b.bidder_name]) {
                    map[b.bidder_name] = b.bid_amount;
                }
            });
            const sorted = Object.entries(map)
                .map(([name, amount]) => ({ name, amount }))
                .sort((a,b)=>b.amount-a.amount);
            
            document.getElementById('biddersList').innerHTML = sorted
                .map((b,i)=>`<div class="bidder-item"><span>${i+1}. ${b.name}</span><span>RM ${b.amount.toLocaleString()}</span></div>`)
                .join('');
        }

        function updateParticipants() {
            if (!bidders) { 
                document.getElementById('participantCount').textContent = '0'; 
                return; 
            }
            const unique = new Set(bidders.map(b=>b.bidder_name));
            document.getElementById('participantCount').textContent = unique.size;
        }

        document.getElementById('userNameInput').addEventListener('keypress', e => { 
            if (e.key === 'Enter') joinAuction(); 
        });
    </script>
</body>
</html>
