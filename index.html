<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KL Property Auction Live</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #0f172a 100%);
            color: white;
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { padding: 30px 0; margin-bottom: 40px; }
        .header h1 { font-size: 2.5rem; background: linear-gradient(90deg, #a5f3fc 0%, #60a5fa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .input-group { display: flex; gap: 10px; max-width: 400px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; background: rgba(30, 58, 138, 0.5); border: 1px solid rgba(34, 211, 238, 0.5); border-radius: 8px; color: white; }
        button { padding: 12px 24px; background: linear-gradient(90deg, #06b6d4 0%, #3b82f6 100%); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; }
        .main-content { display: grid; grid-template-columns: 1fr 350px; gap: 30px; }
        .auction-card { background: linear-gradient(135deg, rgba(30, 58, 138, 0.4), rgba(30, 99, 145, 0.4)); border: 1px solid rgba(34, 211, 238, 0.3); border-radius: 20px; padding: 40px; }
        .property-image { font-size: 4rem; text-align: center; padding: 40px 0; }
        .property-address { font-size: 2rem; font-weight: bold; margin: 10px 0; }
        .property-description { color: #93c5fd; font-size: 1.1rem; margin-bottom: 30px; }
        .price-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .price-box { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 20px; }
        .price-amount { font-size: 2rem; font-weight: bold; color: #a5f3fc; }
        .bidder-info { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 30px; }
        .bidder-name { font-size: 1.5rem; font-weight: bold; color: #06b6d4; }
        .bid-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .bid-btn { padding: 16px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; color: white; background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); }
        .bidders-list { background: linear-gradient(135deg, rgba(30, 58, 138, 0.4), rgba(30, 99, 145, 0.4)); border: 1px solid rgba(34, 211, 238, 0.3); border-radius: 20px; padding: 25px; max-height: 700px; overflow-y: auto; }
        .bidder-item { padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; }
        .hidden { display: none; }
        .error { color: #fca5a5; padding: 10px; margin: 10px 0; }
        .success { color: #86efac; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”¨ KL Property Auction Live</h1>
        </div>

        <div id="userInputSection">
            <div class="input-group">
                <input type="text" id="userNameInput" placeholder="è¾“å…¥ä½ çš„åå­—..." />
                <button onclick="joinAuction()">åŠ å…¥ç«æ‹</button>
            </div>
            <div id="statusMsg"></div>
        </div>

        <div id="welcomeText" class="hidden">
            <p style="color: #06b6d4;">æ¬¢è¿, <span id="displayName"></span> ğŸ‘‹ | å‚ä¸äººæ•°: <span id="participantCount">0</span></p>
        </div>

        <div id="mainContent" class="hidden" style="margin-top: 40px;">
            <div class="main-content">
                <div class="auction-card">
                    <div class="property-image" id="propertyImage">ğŸ¢</div>
                    <h2 class="property-address" id="propertyAddress">Pavilion KL</h2>
                    <p class="property-description" id="propertyDescription">è±ªåå…¬å¯“</p>

                    <div class="price-grid">
                        <div class="price-box">
                            <div style="color: #93c5fd; font-size: 0.9rem; margin-bottom: 8px;">èµ·ä»·</div>
                            <div class="price-amount" id="openingPrice">RM 500,000</div>
                        </div>
                        <div class="price-box" style="background: rgba(6, 182, 212, 0.2);">
                            <div style="color: #93c5fd; font-size: 0.9rem; margin-bottom: 8px;">å½“å‰å‡ºä»·</div>
                            <div class="price-amount" id="currentPrice">RM 550,000</div>
                        </div>
                    </div>

                    <div class="bidder-info">
                        <div style="color: #93c5fd; font-size: 0.8rem; margin-bottom: 10px;">æœ€é«˜ç«ä»·è€…</div>
                        <div class="bidder-name" id="highBidder">ç­‰å¾…ä¸­...</div>
                    </div>

                    <div style="font-size: 0.9rem; color: #93c5fd; margin-bottom: 15px;">ä¸‹ä¸€ä¸ªå‡ºä»·å¿…é¡»è‡³å°‘: <strong style="color: #06b6d4; font-size: 1.1rem;" id="minBidDisplay">RM 555,000</strong></div>

                    <div class="bid-buttons">
                        <button class="bid-btn" onclick="placeBid(5000)">+RM 5,000</button>
                        <button class="bid-btn" onclick="placeBid(10000)">+RM 10,000</button>
                        <button class="bid-btn" onclick="placeBid(15000)">+RM 15,000</button>
                        <button class="bid-btn" onclick="placeBid(25000)">+RM 25,000</button>
                    </div>

                    <div id="messageBox" class="hidden" style="padding: 16px; background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.5); border-radius: 10px; color: #86efac;"></div>
                </div>

                <div class="bidders-list">
                    <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 20px;">ğŸ‘¥ ç«ä»·è€…æ’è¡Œ</div>
                    <div id="biddersList" style="text-align: center; color: #93c5fd; padding: 20px;">è¿æ¥ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ubxfggqfnhvqyatgiolx.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVieGZnZ3Fmbmh2cXlhdGdpb2x4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzM3NDEsImV4cCI6MjA4MzUwOTc0MX0.fxlPFVuHlwLG56bPOeP2s6qsoQn5aEgeBrdHfkvjvyM';
        const TABLE_NAME = 'Auction';

        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const properties = [
            { id: 1, address: 'Pavilion KL - è±ªåå…¬å¯“', image: 'ğŸ¢', openingBid: 500000, increment: 5000, description: 'å‰éš†å¡ä¸­å¿ƒé«˜ç«¯ä½å®…' },
            { id: 2, address: 'Petaling Jaya - ç°ä»£ä½å®…', image: 'ğŸ¡', openingBid: 350000, increment: 5000, description: 'å®¶åº­å‹å–„çš„ç°ä»£ä½å®…' },
            { id: 3, address: 'Bangsar - è±ªå®…', image: 'ğŸ°', openingBid: 650000, increment: 10000, description: 'é«˜ç«¯ç¤¾åŒºçš„ç‹¬ç«‹è±ªå®…' },
            { id: 4, address: 'Subang Jaya - å…¬å¯“', image: 'ğŸ™ï¸', openingBid: 400000, increment: 5000, description: 'ç°ä»£åŒ–åŸå¸‚å…¬å¯“' },
        ];

        let userName = '';
        let selectedProperty = 1;
        let auctionData = null;

        async function joinAuction() {
            const input = document.getElementById('userNameInput');
            userName = input.value.trim();
            
            if (!userName) { alert('è¯·è¾“å…¥ä½ çš„åå­—ï¼'); return; }

            document.getElementById('userInputSection').classList.add('hidden');
            document.getElementById('welcomeText').classList.remove('hidden');
            document.getElementById('displayName').textContent = userName;
            document.getElementById('mainContent').classList.remove('hidden');

            // å®æ—¶è®¢é˜…
            sb.channel('auction-changes')
                .on('postgres_changes', { 
                    event: '*', 
                    schema: 'public', 
                    table: TABLE_NAME 
                }, () => {
                    loadData();
                })
                .subscribe();

            setInterval(loadData, 1000);
            await loadData();
        }

        async function loadData() {
            try {
                const { data, error } = await sb.from(TABLE_NAME).select('*');
                if (error) {
                    console.error('è¯»å–é”™è¯¯:', error);
                    return;
                }
                auctionData = data;
                updateUI();
            } catch (err) {
                console.error('é”™è¯¯:', err);
            }
        }

        async function placeBid(increment) {
            if (!auctionData) return;

            try {
                const current = properties.find(p => p.id === selectedProperty);
                
                // æ‰¾åˆ°è¯¥æˆ¿äº§çš„å½“å‰å‡ºä»·
                const propertyData = auctionData.find(row => row.id === selectedProperty);
                if (!propertyData) {
                    alert('æˆ¿äº§æœªæ‰¾åˆ°ï¼');
                    return;
                }

                const currentPrice = propertyData.current_price || current.openingBid;
                const bidAmount = currentPrice + increment;

                // æ›´æ–°è¯¥æˆ¿äº§è®°å½•
                const { error } = await sb.from(TABLE_NAME).update({ 
                    current_price: bidAmount,
                    bidder_name: userName,
                    stage: 1,
                    timer: 10
                }).eq('id', selectedProperty);

                if (error) {
                    console.error('å‡ºä»·é”™è¯¯:', error);
                    showMessage('âŒ å‡ºä»·å¤±è´¥: ' + error.message);
                    return;
                }

                showMessage(`âœ“ ${userName} æˆåŠŸå‡ºä»· RM ${bidAmount.toLocaleString()}`);
                await loadData();
            } catch (err) {
                console.error('é”™è¯¯:', err);
            }
        }

        function showMessage(text) {
            const box = document.getElementById('messageBox');
            box.innerHTML = text;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 3000);
        }

        function updateUI() {
            updateParticipants();
            renderDisplay();
            renderBidders();
        }

        function updateParticipants() {
            if (!auctionData) return;
            const uniqueBidders = new Set(auctionData.map(r => r.bidder_name).filter(n => n && n !== 'ç­‰å¾…ä¸­...'));
            document.getElementById('participantCount').textContent = uniqueBidders.size;
        }

        function renderDisplay() {
            if (!auctionData) return;
            const current = properties[selectedProperty - 1];
            const propertyData = auctionData.find(row => row.id === selectedProperty);
            
            if (!propertyData) return;

            const currentPrice = propertyData.current_price || current.openingBid;
            const minBid = currentPrice + current.increment;

            document.getElementById('propertyImage').textContent = current.image;
            document.getElementById('propertyAddress').textContent = current.address;
            document.getElementById('propertyDescription').textContent = current.description;
            document.getElementById('openingPrice').textContent = `RM ${current.openingBid.toLocaleString()}`;
            document.getElementById('currentPrice').textContent = `RM ${currentPrice.toLocaleString()}`;
            document.getElementById('highBidder').textContent = propertyData.bidder_name || 'ç­‰å¾…ä¸­...';
            document.getElementById('minBidDisplay').textContent = `RM ${minBid.toLocaleString()}`;
        }

        function renderBidders() {
            if (!auctionData) return;
            
            // æ”¶é›†æ‰€æœ‰ä¸åŒçš„ç«ä»·è€…å’Œä»–ä»¬çš„å‡ºä»·
            const bidderMap = {};
            auctionData.forEach(row => {
                if (row.bidder_name && row.bidder_name !== 'ç­‰å¾…ä¸­...') {
                    if (!bidderMap[row.bidder_name] || row.current_price > bidderMap[row.bidder_name]) {
                        bidderMap[row.bidder_name] = row.current_price;
                    }
                }
            });

            const bidders = Object.entries(bidderMap)
                .map(([name, price]) => ({ name, price }))
                .sort((a, b) => b.price - a.price);

            const list = document.getElementById('biddersList');
            
            if (bidders.length === 0) {
                list.innerHTML = '<div style="color: #93c5fd;">ç­‰å¾…ç«ä»·è€…...</div>';
                return;
            }

            list.innerHTML = bidders.map((b, i) => `
                <div class="bidder-item">
                    <span style="color: #a5f3fc;">${i + 1}. ${b.name}</span>
                    <span style="color: #fbbf24;">RM ${b.price.toLocaleString()}</span>
                </div>
            `).join('');
        }

        document.getElementById('userNameInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') joinAuction();
        });
    </script>
</body>
</html>
